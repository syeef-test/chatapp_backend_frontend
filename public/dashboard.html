<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />



    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>


    <link rel="stylesheet" href="css/style.css">

</head>

<body>

    <section>
        <div class="chat-container">
            <header class="chat-header">
                <h1><i class="fas fa-smile"></i> Chat App</h1>
                <h3>Hello</h3>
                <h3 id="username"></h3>
                <a href="#" class="btn" onclick="logout(event)">Leave Chat App</a>
            </header>
            <main class="chat-main">
                <div class="chat-sidebar">
                    <h3><i class="fas fa-comments"></i>Groups:</h3>

                    <div class="sidebar" id="group_list">
                    </div>

                    <!-- <h2 id="room-name">JavaScript</h2>
                <h3><i class="fas fa-users"></i> Users</h3>
                <ul id="users">
                  <li>Brad</li>
                  <li>John</li>
                  <li>Mary</li>
                  <li>Paul</li>
                  <li>Mike</li>
                </ul> -->
                </div>

                <div class="chat-messages">
                    <div id="message_list" name="message_list" class="list-group"></div>
                </div>
            </main>
            <div class="chat-form-container">
                <form id="chat-form" onsubmit="sendmessage(event)">
                    <input type="text" id="message" name="message" placeholder="Enter Text Here" aria-label="text"
                        required />
                    <input type="file" id="file" name="file" placeholder="Choose File " aria-label="text" />
                    <button class="btn btn-outline-success" type="submit">
                        <i class="fas fa-paper-plane"></i>Send
                    </button>
                </form>
            </div>
            <div class="chat-form-container">
                <div id="sidebar">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="sidebar" id="group_list">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-sm">
                    <form class="d-flex" onsubmit="create_group(event)" enctype="multipart/form-data">
                        <input class="form-control me-2" type="text" id="group_name" name="group_name"
                            placeholder="Enter Group Name" aria-label="text" />
                        <button class="btn btn-outline-success" type="submit">
                            Create Group
                        </button>
                    </form>
                </div>
                <div>
                    <button onclick="show_participate_form()" class="btn btn-outline-success"
                        id="add_participate_btn">ADD
                        or Remove
                        Participate</button>

                    <input style="display: none;" type="text" name="search_box" class="form-control form-control-lg"
                        placeholder="Type Here..." id="search_box" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" onkeyup="javascript:load_data(this.value)" />

                    <div id="participent" style="display: none;">
                        <form onsubmit="add_participent(event)">

                            <div class="card">
                                <div class="card-header">Search User For Group</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <span id="search_result"></span>
                                    </div>
                                </div>
                                <div class="card-header">Select Group</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <select name="group" id="group" class="form-control" required>

                                        </select>
                                    </div>
                                </div>
                                <div class="card-header">Select User Type</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <select name="type" id="type" class="form-control">
                                            <option value="true">Admin</option>
                                            <option value="false" selected>Normal User</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="radio_action"
                                            id="radio_action" value="Add" checked />
                                        <label class="form-check-label" for="radio_action">Add</label>
                                    </div>

                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="radio_action"
                                            id="radio_action" value="Remove" />
                                        <label class="form-check-label" for="radio_action">Remove</label>
                                    </div>

                                </div>
                                <div>
                                    <button type="submit" class="btn btn-outline-warning">Submit</button>
                                </div>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
    integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
    crossorigin="anonymous"></script>
<script>
    //socket part
    const socket = io("http://127.0.0.1:3000");

    socket.on('connect', () => {
        console.log(`You are connected with id:${socket.id}`);


    });


    socket.on('recive_message', message => {
        // console.log(message);
        // console.log(message.groupName);
        // console.log(message.chatData);

        //when user join group
        if (message.groupName && message.chatData) {
            console.log('show chats of group onscreen');
            deleteElementfromscreen();
            showonscreen(message.chatData);
        }

        else if (message.chatData) {
            console.log('show singale chat onscreen');
            showonscreen(message.chatData);
        }
    });

    socket.on('status_message', message => {
        alert(message.message);
        console.log(message);
    });



    function sendmessage(event) {
        event.preventDefault();
        const content = event.target.message.value;
        event.target.message.value = '';
        if (localStorage.getItem('group_id')) {
            
        
        const group_id = localStorage.getItem('group_id');
        const token = localStorage.getItem('token');
        const fileInput = document.getElementById('file').files;
        if (fileInput[0]) {
            const file_name = fileInput[0].name;
            const file_size = fileInput[0].size;
            const file_type = fileInput[0].type;
            socket.emit('send_message', { content: content, group_id: group_id, token: token, fileInput: fileInput, file_name: file_name, file_size: file_size, file_type: file_type });
        }

        socket.emit('send_message', { content: content, group_id: group_id, token: token });
        }
    }

    // function getmessage(id){
    //     const group_id = id;
    //     socket.emit('get_message',{group_id:group_id});
    // }

    function joingroup(id) {
        // alert(id);
        const group_id = id;
        localStorage.setItem('group_id', group_id);
        const token = localStorage.getItem('token');

        socket.emit('join_group', { group_id: id, token: token });
        const join_button = document.getElementById('groupjbtn' + id);
        join_button.style.display = 'none';
        const disconect_button = document.getElementById('groupdbtn' + id);
        disconect_button.style.display = 'block';
        alert("Connection Succesful");
    }

    function disconnectgroup(id) {

        const token = localStorage.getItem('token');
        socket.emit('disconnect_group', { group_id: id, token: token });
        const join_button = document.getElementById('groupjbtn' + id);
        join_button.style.display = 'block';
        const disconect_button = document.getElementById('groupdbtn' + id);
        disconect_button.style.display = 'none';
        deleteElementfromscreen();
        //alert("Disconect Succesful");
    }

    async function load_data(query) {
        try {
            //alert("search");
            if (query.length > 2) {

                //alert(query);
                const token = localStorage.getItem('token');
                const response = await axios.post('http://127.0.0.1:3000/group/get_data', { query: query }, {
                    headers: {
                        'authorization': token,
                    },

                });


                if (response.data) {

                    var html = `<select class="form-select" multiple aria-label="multiple select example" name="user_list" id="user_list" required>`;
                    if (response.data.data.length > 0) {
                        for (var count = 0; count < response.data.data.length; count++) {
                            html += `<option  value="${response.data.data[count].id}">${response.data.data[count].name}</option>`;
                        }
                    } else {
                        html += `<option value="" disabled>No Data Found</option>`;
                    }


                    html += '</select>';
                    document.getElementById('search_result').innerHTML = html;
                }

            } else {
                // alert("Please Enter Atleast Three Character");
                document.getElementById('search_result').innerHTML = '';
            }
        } catch (error) {
            console.log(error);
        }
    }

    window.addEventListener("DOMContentLoaded", () => {
        try {

            if (localStorage.getItem('username')) {
                const h_element = document.getElementById('username');
                h_element.textContent = localStorage.getItem('username');
            }
            get_groups_data();

        } catch (error) {
            console.log(error);
        }
    })

    function showonscreen(chatData) {
        try {
            const parentElement = document.getElementById("message_list");
            const obj = chatData;
            //console.log(obj);

            const liElement = document.createElement('ul');
            liElement.className = "message_list_item";
            liElement.id = "message_list_item";

            if (obj.length > 1) {
                console.log("multipale element");
                // console.log(typeof(obj));
                obj.forEach((element) => {
                    let date = new Date(element.createdAt);
                    let createdAt = moment(date).format('h:mm a');

                    if(element.fileurl !== ''){
                        var childElem = `<ul class="list-group-item message" id="${element.id}"><div class="message"><p class="meta">${element.user.name}<span>${createdAt}</span></p>
                        <p class="text">
                            ${element.message}
                        </p>
                        <span><img  src="${element.fileurl}" width="20%" height="20%"></span></div></ul>`;
                    }else{
                        var childElem = `<ul class="list-group-item message" id="${element.id}"><div class="message"><p class="meta">${element.user.name}<span>${createdAt}</span></p>
                        <p class="text">
                            ${element.message}
                        </p>
                        </div></ul>`;
                    }
                    

                   


                    liElement.innerHTML = liElement.innerHTML + childElem;

                });
            } else {
                console.log("one element");
                // console.log(typeof(obj));
                const element = obj;
                //console.log(element);
                //console.log(Object.keys(element).length);
                // console.log(element.user.name);
                if (Object.keys(element).length > 0) {
                    let date = new Date(element.createdAt);
                    let createdAt = moment(date).format('h:mm a');

                    if(element.fileurl !== ''){
                    var childElem = `<ul class="list-group-item message" id="${element.id}"><div class="message"><p class="meta">${element.user.name}<span>${createdAt}</span></p>
                        <p class="text">
                            ${element.message}
                        </p>
                    <span><img  src="${element.fileurl}" width="20%" height="20%"></span></div></ul>`;
                    }else{
                        var childElem = `<ul class="list-group-item message" id="${element.id}"><div class="message"><p class="meta">${element.user.name}<span>${createdAt}</span></p>
                        <p class="text">
                            ${element.message}
                        </p>
                    </div></ul>`;
                    }
                    liElement.innerHTML = liElement.innerHTML + childElem;
                }

            }


            parentElement.appendChild(liElement);


        } catch (error) {
            console.log(error);
        }
    }

    function deleteElementfromscreen() {
        let n1 = Array.from(document.getElementsByClassName('message_list_item'));
        n1.forEach(n => {
            n.remove();
        });
        let nodes = Array.from(document.getElementsByClassName('list-group-item message'));
        nodes.forEach(node => {
            node.remove();
        });
    }
    function logout(event) {
        try {
            localStorage.removeItem('token');
            localStorage.clear();
            window.location = "index.html";
        } catch (error) {
            console.log(error);
        }

    }
    async function create_group(event) {
        try {
            event.preventDefault();
            const group_name = event.target.group_name.value;
            event.target.group_name.value = '';
            //console.log(group_name);
            if (group_name !== null && group_name !== undefined && group_name !== '') {
                const token = localStorage.getItem('token');
                const data = await axios.post('http://127.0.0.1:3000/group/create_group', { group_name: group_name }, {
                    headers: {
                        'authorization': token
                    }
                });
                response = data.data;
                if (response) {
                    alert(response.message);
                    show_group_onscreen(response.data);
                    const btn = document.getElementById('add_participate_btn');
                    btn.style.display = 'block';

                } else {
                    alert("please try again later");
                }
            }

        } catch (error) {
            console.log(error);
        }
    }
    async function get_groups_data() {
        try {
            const token = localStorage.getItem('token');

            const data = await axios.get('http://127.0.0.1:3000/group/get_group', {
                headers: {
                    'authorization': token
                }
            });
            response = data.data;

            if (response) {
                response.data.forEach(element => {
                    show_group_onscreen(element);
                });

                if (response.isAdmin === 0) {
                    const btn = document.getElementById('add_participate_btn');
                    btn.style.display = 'none';
                }
            }
            //console.log(response);
        } catch (error) {
            console.log(error);
            //no data of group so hide participate btn
            const btn = document.getElementById('add_participate_btn');
            btn.style.display = 'none';

        }
    }
    function show_group_onscreen(element) {
        try {
            //console.log(element);
            const parentElement = document.getElementById('group_list');
            let childElem = `<li class='btn btn-warning btn-sm' id='group${element.id}' value='${element.id}'>${element.name}</li>`;
            const left_button = `<ul><button class='btn btn-danger btn-sm' id='grouplbtn${element.id}' value='${element.id}' onclick='leftGroup(this.value)'>Left Group</button></ul>`;
            const join_button = `<ul><button class='btn btn-success btn-sm' id='groupjbtn${element.id}' value='${element.id}' onclick='joingroup(this.value)'>Join Group</button></ul>`;
            const disconnect_button = `<ul><button style="display: none;" class='btn btn-info btn-sm' id='groupdbtn${element.id}' value='${element.id}' onclick='disconnectgroup(this.value)'>Disconnect</button></ul>`;
            childElem += left_button;
            childElem += join_button;
            childElem += disconnect_button;
            parentElement.innerHTML = parentElement.innerHTML + childElem;
        } catch (error) {
            console.log(error);
        }

    }
    function show_participate_form() {
        // alert("show form")
        const div_element = document.getElementById('participent');
        const search_element = document.getElementById('search_box');

        if (div_element.style.display === 'none') {
            div_element.style.display = 'block';
            search_element.style.display = 'block';
            //call function to fetch all group created by user
            get_group_for_dropdown();
        } else {
            div_element.style.display = 'none';
            search_element.style.display = 'none';
        }

    }
    async function get_group_for_dropdown() {
        try {
            const token = localStorage.getItem('token');

            data = await axios.get('http://127.0.0.1:3000/group/get_group_for_dropdown', {
                headers: {
                    'authorization': token
                }
            });
            response = data.data;
            if (response.data.length > 0) {
                let select_element = document.getElementById('group');
                var html = '';
                for (var count = 0; count < response.data.length; count++) {
                    html += '<option value="' + response.data[count].id + '">' + response.data[count].name + '</option>';
                    //console.log(response.data);
                }

                select_element.innerHTML = html;

            }
        } catch (error) {
            console.log(error);
        }
    }

    async function add_participent(event) {
        try {
            event.preventDefault();
            const group_id = event.target.group.value;
            const user_list = event.target.user_list.selectedOptions;
            var values = Array.from(user_list).map(({ value }) => value);
            //console.log(values);
            const type = event.target.type.value;

            const action = event.target.radio_action.value

            const token = localStorage.getItem('token');
            const data = await axios.post('http://127.0.0.1:3000/group/add_participent', { group_id: group_id, user_ids: values, type: type, action: action }, {
                headers: {
                    'authorization': token
                }
            });

            const response = data.data;
            if (response) {
                console.log(response);
                alert(response.message);
            }


        } catch (error) {
            console.log(error);
        }

    }
    async function leftGroup(id) {
        try {
            var result = confirm("Are you sure to delete?");

            if (result) {
                const group_id = id;
                const token = localStorage.getItem('token');
                const response = await axios.post('http://127.0.0.1:3000/group/left_group', { group_id: group_id }, {
                    headers: {
                        'authorization': token
                    }
                });

                if (response) {
                    //remove group button from screen
                    const gr_li = document.getElementById(`group${group_id}`);
                    const left_button = document.getElementById(`grouplbtn${group_id}`);
                    const join_button = document.getElementById(`groupjbtn${group_id}`);
                    const disconnect_button = document.getElementById(`groupdbtn${group_id}`);
                    left_button.parentElement.removeChild(left_button);
                    join_button.parentElement.removeChild(join_button);
                    disconnect_button.parentElement.removeChild(disconnect_button);
                    gr_li.parentElement.removeChild(gr_li);
                    alert(response.data.message);

                }
            }

        } catch (error) {
            console.log(error);
        }
    }
</script>

</html>